<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SmartWallet AI">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<title>SmartWallet AI</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#000;--card:#1C1C1E;--card2:#2C2C2E;--card3:#3A3A3C;
--text:#FFF;--text2:#8E8E93;--text3:#636366;
--green:#32D74B;--red:#FF453A;--blue:#0A84FF;--orange:#FF9F0A;
--yellow:#FFD60A;--purple:#BF5AF2;--pink:#FF375F;--teal:#30D5C8;
--r:20px;
--sat:env(safe-area-inset-top,20px);
--sab:env(safe-area-inset-bottom,0px)
}
html,body{
font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text','Helvetica Neue',sans-serif;
background:var(--bg);color:var(--text);
min-height:100vh;min-height:100dvh;
overflow-x:hidden;-webkit-font-smoothing:antialiased;
-webkit-tap-highlight-color:transparent;-webkit-text-size-adjust:100%
}
body{padding-top:var(--sat);padding-bottom:calc(72px + var(--sab))}
::-webkit-scrollbar{display:none}

/* Header */
.hdr{position:sticky;top:0;z-index:100;padding:12px 20px 10px;
background:rgba(0,0,0,.82);-webkit-backdrop-filter:saturate(180%) blur(20px);backdrop-filter:saturate(180%) blur(20px);
border-bottom:.5px solid rgba(255,255,255,.08)}
.hdr-top{display:flex;justify-content:space-between;align-items:center}
.hdr h1{font-size:28px;font-weight:700;letter-spacing:-.5px}
.hdr-sub{font-size:13px;color:var(--text2);margin-top:2px}

/* User chip */
.usr-chip{display:flex;align-items:center;gap:8px;cursor:pointer}
.usr-ava-placeholder{width:32px;height:32px;border-radius:50%;background:var(--card2);
display:flex;align-items:center;justify-content:center;font-size:14px}
.db-badge{display:flex;align-items:center;gap:5px;padding:4px 8px;border-radius:10px;font-size:10px;font-weight:600;border:none}
.db-badge.live{background:rgba(50,215,75,.12);color:var(--green)}
.db-badge.off{background:var(--card2);color:var(--text2)}
.db-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.db-badge.live .db-dot{animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* Login Screen */
.login-screen{
position:fixed;inset:0;z-index:600;background:var(--bg);
display:flex;flex-direction:column;align-items:center;justify-content:center;
padding:40px;text-align:center;gap:20px
}
.login-screen.hide{display:none}
.login-logo{font-size:64px;margin-bottom:8px}
.login-title{font-size:32px;font-weight:700;letter-spacing:-.5px}
.login-sub{font-size:15px;color:var(--text2);line-height:1.5;max-width:300px}
.login-form{width:100%;max-width:320px;display:flex;flex-direction:column;gap:12px;margin-top:8px}
.login-fi{text-align:center}
.login-main-btn{margin-top:4px}
.login-switch{background:none;border:none;color:var(--text2);font-size:14px;
font-family:inherit;cursor:pointer;padding:8px;transition:color .2s}
.login-switch strong{color:var(--blue)}
.login-switch:active{color:var(--text)}
.login-err{font-size:13px;color:var(--red);text-align:center;min-height:18px;line-height:1.4}

/* Pages */
.pg{display:none;padding:16px 20px 30px;animation:fadeUp .3s ease}
.pg.on{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* Cards */
.c{background:var(--card);border-radius:var(--r);padding:20px;margin-bottom:14px;transition:transform .15s,opacity .15s}
.c:active{transform:scale(.98);opacity:.9}
.c-t{font-size:13px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}

/* Balance */
.bal-c{background:linear-gradient(135deg,#1C1C1E,#2C2C2E);border:1px solid rgba(255,255,255,.06);position:relative;overflow:hidden}
.bal-c::after{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;
background:radial-gradient(circle,rgba(50,215,75,.06),transparent 70%);pointer-events:none}
.bal-n{font-size:44px;font-weight:700;letter-spacing:-1.5px;margin:4px 0}
.bal-n.pos{color:var(--green)}.bal-n.neg{color:var(--red)}
.bal-l{font-size:14px;color:var(--text2)}

/* Stats row */
.st-row{display:flex;gap:10px;margin-bottom:14px}
.st-card{flex:1;background:var(--card);border-radius:var(--r);padding:14px;text-align:center}
.st-val{font-size:22px;font-weight:700;margin-top:5px}
.st-lbl{font-size:11px;color:var(--text2);letter-spacing:.3px}

/* Progress */
.pr-w{margin-bottom:14px}
.pr-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.pr-n{font-size:14px;font-weight:500}
.pr-v{font-size:13px;color:var(--text2)}
.pr-bar{height:7px;background:var(--card2);border-radius:4px;overflow:hidden}
.pr-fill{height:100%;border-radius:4px;transition:width .6s cubic-bezier(.4,0,.2,1)}

/* Tip */
.tip{background:linear-gradient(135deg,rgba(10,132,255,.12),rgba(191,90,242,.08));
border:1px solid rgba(10,132,255,.2);border-radius:var(--r);padding:18px;margin-bottom:14px}
.tip-tag{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.tip-ico{font-size:26px;margin-bottom:6px}
.tip-txt{font-size:14px;line-height:1.5;color:rgba(255,255,255,.9)}

/* FAB */
.fab{position:fixed;bottom:calc(82px + var(--sab));right:20px;z-index:90;
width:56px;height:56px;border-radius:28px;background:var(--blue);
border:none;color:#fff;font-size:28px;font-weight:300;
display:flex;align-items:center;justify-content:center;
box-shadow:0 4px 20px rgba(10,132,255,.4);transition:transform .15s;cursor:pointer}
.fab:active{transform:scale(.88)}

/* Nav */
.nav{position:fixed;bottom:0;left:0;right:0;z-index:100;
background:rgba(28,28,30,.82);-webkit-backdrop-filter:saturate(180%) blur(20px);backdrop-filter:saturate(180%) blur(20px);
border-top:.5px solid rgba(255,255,255,.08);display:flex;justify-content:space-around;align-items:flex-start;
padding:8px 0 calc(8px + var(--sab));height:calc(72px + var(--sab))}
.nav-i{display:flex;flex-direction:column;align-items:center;gap:3px;
background:none;border:none;color:var(--text2);font-size:10px;font-weight:500;cursor:pointer;padding:4px 14px;transition:color .2s}
.nav-i.on{color:var(--blue)}
.nav-ic{font-size:22px;height:24px;display:flex;align-items:center}

/* Modal */
.mo{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.55);
-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center}
.mo.open{display:flex}
.mo-s{background:var(--card);border-radius:20px 20px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;
padding:20px 20px calc(20px + var(--sab));transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1)}
.mo.open .mo-s{transform:none}
.mo-h{width:36px;height:5px;background:rgba(255,255,255,.18);border-radius:3px;margin:0 auto 18px}
.mo-t{font-size:20px;font-weight:700;margin-bottom:18px;text-align:center}

/* Form */
.fg{margin-bottom:16px}
.fl{display:block;font-size:13px;color:var(--text2);margin-bottom:6px;font-weight:500}
.fi{width:100%;padding:14px 16px;background:var(--card2);border:1px solid rgba(255,255,255,.08);
border-radius:12px;color:var(--text);font-size:16px;outline:none;font-family:inherit;
transition:border-color .2s;-webkit-appearance:none}
.fi:focus{border-color:var(--blue)}
.fi::placeholder{color:rgba(255,255,255,.22)}

/* Type toggle (expense/income) */
.type-tog{display:flex;gap:0;background:var(--card2);border-radius:12px;padding:3px;margin-bottom:16px}
.type-btn{flex:1;padding:10px;border:none;border-radius:10px;font-size:14px;font-weight:600;
font-family:inherit;cursor:pointer;transition:all .2s;background:transparent;color:var(--text2)}
.type-btn.sel-exp{background:var(--red);color:#fff}
.type-btn.sel-inc{background:var(--green);color:#fff}

/* Cat */
.cg{display:flex;flex-wrap:wrap;gap:8px}
.ct{padding:8px 14px;border-radius:20px;font-size:13px;font-weight:500;
background:var(--card2);border:1.5px solid rgba(255,255,255,.06);color:var(--text2);
cursor:pointer;transition:all .2s;user-select:none;-webkit-user-select:none}
.ct.sel{background:rgba(10,132,255,.2);border-color:var(--blue);color:var(--blue)}

/* Btns */
.btn{width:100%;padding:16px;border:none;border-radius:14px;font-size:16px;
font-weight:600;font-family:inherit;cursor:pointer;transition:transform .12s,opacity .12s}
.btn:active{transform:scale(.97);opacity:.85}
.btn-b{background:var(--blue);color:#fff}
.btn-g{background:var(--green);color:#fff}
.btn-r{background:var(--red);color:#fff}
.btn-s{background:var(--card2);color:var(--text)}

/* TX */
.tx-wrap{position:relative;overflow:hidden;border-bottom:.5px solid rgba(255,255,255,.06)}
.tx-wrap:last-child{border-bottom:none}
.tx-del-bg{position:absolute;right:0;top:0;bottom:0;width:80px;background:var(--red);
display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:600;
opacity:0;transition:opacity .2s}
.tx-wrap.swiped .tx-del-bg{opacity:1}
.tx{display:flex;align-items:center;gap:14px;padding:14px 0;transition:transform .25s ease;background:var(--bg);position:relative;z-index:1}
.tx-wrap .tx{background:var(--card)}
.tx-ic{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.tx-d{flex:1;min-width:0}
.tx-n{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-m{font-size:12px;color:var(--text2);margin-top:2px}
.tx-a{font-size:16px;font-weight:600;flex-shrink:0}
.tx-a.expense{color:var(--red)}
.tx-a.income{color:var(--green)}

/* Quick Add */
.qa-row{display:flex;gap:8px;overflow-x:auto;padding:2px 0 14px;-webkit-overflow-scrolling:touch}
.qa-row::-webkit-scrollbar{display:none}
.qa-btn{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:4px;
padding:12px 14px;background:var(--card);border:1.5px solid rgba(255,255,255,.06);
border-radius:16px;font-size:11px;font-weight:600;color:var(--text2);
cursor:pointer;transition:all .15s;user-select:none;min-width:72px;font-family:inherit}
.qa-btn:active{transform:scale(.92);opacity:.8;background:var(--card2)}
.qa-btn.inc{border-color:rgba(50,215,75,.2)}
.qa-ico{font-size:24px}
.qa-amt{font-size:13px;font-weight:700}
.qa-amt.expense{color:var(--text)}
.qa-amt.income{color:var(--green)}

/* Quick Add manage in settings */
.qa-list{margin-bottom:12px}
.qa-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card);
border-radius:12px;margin-bottom:6px}
.qa-item-ico{font-size:20px;width:28px;text-align:center}
.qa-item-info{flex:1;font-size:14px;font-weight:500}
.qa-item-amt{font-size:14px;font-weight:700}
.qa-item-amt.expense{color:var(--red)}
.qa-item-amt.income{color:var(--green)}
.qa-item-del{background:none;border:none;color:var(--red);font-size:18px;padding:4px 8px;cursor:pointer;opacity:.6}
.qa-item-del:active{opacity:1}
.qa-add-form{background:var(--card);border-radius:14px;padding:14px;margin-top:8px}
.qa-add-row{display:flex;gap:8px;margin-bottom:8px}
.qa-add-row .fi{padding:10px 12px;font-size:14px}
.qa-add-row .fi.sm{width:60px;flex-shrink:0;text-align:center}
.qa-add-type-row{display:flex;gap:8px;margin-bottom:8px}
.qa-add-type-btn{flex:1;padding:8px;border:1.5px solid rgba(255,255,255,.08);border-radius:10px;
background:var(--card2);color:var(--text2);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s}
.qa-add-type-btn.sel-exp{border-color:var(--red);background:rgba(255,69,58,.12);color:var(--red)}
.qa-add-type-btn.sel-inc{border-color:var(--green);background:rgba(50,215,75,.12);color:var(--green)}

/* Savings Tracker */
.sav-c{background:linear-gradient(135deg,rgba(50,215,75,.08),rgba(10,132,255,.06));
border:1px solid rgba(50,215,75,.15);position:relative;overflow:hidden}
.sav-amt{font-size:28px;font-weight:700;color:var(--green);margin:6px 0}
.sav-msg{font-size:14px;color:var(--text2);line-height:1.4;margin-top:8px}
.sav-bar{height:10px;background:var(--card2);border-radius:5px;overflow:hidden;margin-top:10px}
.sav-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--green),var(--teal));transition:width .6s cubic-bezier(.4,0,.2,1)}

/* Search */
.search-wrap{position:relative;margin-bottom:14px}
.search-fi{width:100%;padding:12px 16px 12px 40px;background:var(--card2);border:1px solid rgba(255,255,255,.08);
border-radius:14px;color:var(--text);font-size:15px;outline:none;font-family:inherit;-webkit-appearance:none}
.search-fi:focus{border-color:var(--blue)}
.search-fi::placeholder{color:rgba(255,255,255,.22)}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:16px;color:var(--text2);pointer-events:none}

/* Statistics Page */
.chart-section{margin-bottom:24px}
.chart-title{font-size:16px;font-weight:700;margin-bottom:14px}
.bar-chart{display:flex;align-items:flex-end;gap:8px;height:180px;padding:10px 0}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.bar-rect{width:100%;border-radius:8px 8px 4px 4px;background:linear-gradient(180deg,var(--blue),rgba(10,132,255,.5));
transition:height .6s cubic-bezier(.4,0,.2,1);min-height:4px}
.bar-val{font-size:11px;font-weight:600;color:var(--text2)}
.bar-lbl{font-size:10px;color:var(--text3);text-align:center;line-height:1.2}
.cat-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.cat-bar-icon{font-size:18px;width:28px;text-align:center;flex-shrink:0}
.cat-bar-info{flex:1;min-width:0}
.cat-bar-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.cat-bar-name{font-size:13px;font-weight:500}
.cat-bar-val{font-size:12px;color:var(--text2)}
.cat-bar-track{height:6px;background:var(--card2);border-radius:3px;overflow:hidden}
.cat-bar-fill{height:100%;border-radius:3px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.cmp-row{display:flex;gap:12px;margin-bottom:14px}
.cmp-card{flex:1;background:var(--card);border-radius:16px;padding:16px;text-align:center}
.cmp-lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.cmp-val{font-size:24px;font-weight:700;margin-top:6px}
.cmp-diff{font-size:12px;margin-top:4px;font-weight:600}
.cat-cmp-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:.5px solid rgba(255,255,255,.06)}
.cat-cmp-row:last-child{border-bottom:none}
.cat-cmp-icon{font-size:18px;width:28px;text-align:center;flex-shrink:0}
.cat-cmp-info{flex:1;min-width:0}
.cat-cmp-name{font-size:13px;font-weight:500}
.cat-cmp-vals{font-size:12px;color:var(--text2);margin-top:2px}
.cat-cmp-diff{font-size:13px;font-weight:700;flex-shrink:0;padding:4px 10px;border-radius:8px}
.cat-cmp-diff.better{color:var(--green);background:rgba(50,215,75,.1)}
.cat-cmp-diff.worse{color:var(--red);background:rgba(255,69,58,.1)}
.cat-cmp-diff.same{color:var(--text2);background:var(--card2)}
.ai-insight{background:linear-gradient(135deg,rgba(10,132,255,.08),rgba(191,90,242,.06));
border:1px solid rgba(10,132,255,.15);border-radius:16px;padding:16px;margin-bottom:10px}
.ai-insight-ico{font-size:20px;margin-bottom:4px}
.ai-insight-txt{font-size:14px;line-height:1.5;color:rgba(255,255,255,.88)}

/* Shared Wallet */
.sw-code{font-size:32px;font-weight:800;letter-spacing:4px;text-align:center;
padding:16px;background:var(--card2);border-radius:14px;margin:12px 0;color:var(--blue);font-family:monospace}
.sw-status{display:flex;align-items:center;gap:8px;padding:12px 16px;background:rgba(50,215,75,.08);
border:1px solid rgba(50,215,75,.15);border-radius:14px;margin-bottom:12px}
.sw-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
.sw-txt{font-size:14px;color:var(--green);font-weight:500}
.sw-input-row{display:flex;gap:8px;margin-top:8px}
.sw-input-row .fi{flex:1;text-align:center;font-size:18px;letter-spacing:4px;font-family:monospace}
.sw-input-row .btn{width:auto;padding:14px 20px;flex-shrink:0}

/* Settings */
.ss{margin-bottom:24px}
.ss-t{font-size:18px;font-weight:700;margin-bottom:14px}
.sr{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--card);border-radius:14px;margin-bottom:8px}
.sr-l{font-size:15px;font-weight:500}
.sr-i{width:100px;padding:8px 12px;background:var(--card2);border:1px solid rgba(255,255,255,.08);
border-radius:10px;color:var(--text);font-size:15px;text-align:right;font-family:inherit;outline:none;-webkit-appearance:none}
.sr-i:focus{border-color:var(--blue)}
.sr-s{font-size:14px;color:var(--text2);margin-left:4px}

/* Misc */
.empty{text-align:center;padding:40px 20px;color:var(--text2)}
.empty-i{font-size:48px;margin-bottom:12px}
.empty-t{font-size:15px;line-height:1.5}
.dsep{font-size:13px;font-weight:600;color:var(--text2);padding:12px 0 6px;text-transform:uppercase;letter-spacing:.5px}
.ver{text-align:center;color:var(--text3);font-size:12px;margin-top:24px;padding-bottom:20px}

/* Logout */
.logout-row{display:flex;align-items:center;gap:14px;padding:16px;background:var(--card);border-radius:14px;margin-bottom:16px}
.logout-info{flex:1}
.logout-name{font-size:15px;font-weight:600}
.logout-email{font-size:12px;color:var(--text2);margin-top:2px}
.logout-btn{background:none;border:1px solid rgba(255,69,58,.3);color:var(--red);
padding:8px 14px;border-radius:10px;font-size:13px;font-weight:600;font-family:inherit;cursor:pointer}

.rst{margin-top:20px;padding:14px;background:rgba(255,69,58,.08);border:1px solid rgba(255,69,58,.15);
border-radius:14px;color:var(--red);font-size:15px;font-weight:600;width:100%;cursor:pointer;font-family:inherit}

/* Confirm */
.cfm{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.5);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);
display:none;align-items:center;justify-content:center;padding:40px}
.cfm.open{display:flex}
.cfm-b{background:var(--card2);border-radius:16px;padding:24px;text-align:center;max-width:300px;width:100%;animation:pop .25s cubic-bezier(.32,.72,0,1)}
@keyframes pop{from{transform:scale(.85);opacity:0}to{transform:scale(1);opacity:1}}
.cfm-m{font-size:15px;margin-bottom:20px;line-height:1.5}
.cfm-r{display:flex;gap:10px}
.cfm-r .btn{flex:1;padding:12px}

/* Toast */
.toast{position:fixed;top:calc(var(--sat) + 60px);left:50%;transform:translateX(-50%) translateY(-20px);
z-index:400;padding:12px 20px;border-radius:14px;font-size:14px;font-weight:600;
opacity:0;transition:all .3s cubic-bezier(.32,.72,0,1);pointer-events:none;max-width:88%;text-align:center;
-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.ok{background:rgba(50,215,75,.18);color:var(--green);border:1px solid rgba(50,215,75,.25)}
.toast.err{background:rgba(255,69,58,.18);color:var(--red);border:1px solid rgba(255,69,58,.25)}
.toast.inf{background:rgba(10,132,255,.18);color:var(--blue);border:1px solid rgba(10,132,255,.25)}

/* Cat colors */
.cc-food{background:rgba(255,159,10,.15);color:var(--orange)}
.cc-super{background:rgba(255,214,10,.15);color:var(--yellow)}
.cc-transport{background:rgba(10,132,255,.15);color:var(--blue)}
.cc-ent{background:rgba(191,90,242,.15);color:var(--purple)}
.cc-shop{background:rgba(255,55,95,.15);color:var(--pink)}
.cc-health{background:rgba(50,215,75,.15);color:var(--green)}
.cc-bills{background:rgba(255,69,58,.15);color:var(--red)}
.cc-other{background:rgba(142,142,147,.15);color:var(--text2)}
.cc-income{background:rgba(50,215,75,.15);color:var(--green)}

/* Loading */
.ld{position:fixed;inset:0;z-index:500;background:var(--bg);
display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .4s}
.ld.hide{opacity:0;pointer-events:none}
.ld-sp{width:36px;height:36px;border:3px solid var(--card2);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.ld-t{font-size:14px;color:var(--text2)}

/* Bills checklist */
.bill-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--card2);
border-radius:12px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.bill-item:active{transform:scale(.98);opacity:.85}
.bill-ico{font-size:20px;width:28px;text-align:center;flex-shrink:0}
.bill-info{flex:1;min-width:0}
.bill-name{font-size:14px;font-weight:500}
.bill-amt{font-size:12px;color:var(--text2);margin-top:1px}
.bill-status{padding:5px 10px;border-radius:8px;font-size:11px;font-weight:700;flex-shrink:0}
.bill-status.pending{background:rgba(255,159,10,.12);color:var(--orange)}
.bill-status.paid{background:rgba(50,215,75,.12);color:var(--green)}
.bill-add-row{display:flex;gap:8px;margin-top:8px}
.bill-add-row .fi{padding:10px 12px;font-size:14px}
.bill-add-row .fi.sm{width:50px;flex-shrink:0;text-align:center}

/* App container */
.app-wrap{display:none}
.app-wrap.show{display:block}
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScr">
<div class="login-logo">ğŸ’°</div>
<div class="login-title">SmartWallet AI</div>
<div class="login-sub">ÎŸ Ï€ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒÏ‚ ÏƒÎ¿Ï… Î¿Î¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÏŒÏ‚ Î²Î¿Î·Î¸ÏŒÏ‚. Î¦Ï„Î¹Î¬Î¾Îµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Î³Î¹Î± Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÎ¿Ï… ÏƒÏ„Î¿ cloud.</div>
<div class="login-form">
<input type="email" class="fi login-fi" id="authEmail" placeholder="Email" autocomplete="email">
<input type="password" class="fi login-fi" id="authPass" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ (min 6 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚)" autocomplete="current-password">
<div class="login-err" id="authErr"></div>
<button class="btn btn-b login-main-btn" id="authBtn" onclick="doAuth()">Î£ÏÎ½Î´ÎµÏƒÎ·</button>
<button class="login-switch" id="authSwitch" onclick="toggleAuthMode()">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ; <strong>Î•Î³Î³ÏÎ±Ï†Î®</strong></button>
</div>
</div>

<!-- Loading -->
<div class="ld hide" id="loadScr">
<div class="ld-sp"></div>
<div class="ld-t">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Main App -->
<div class="app-wrap" id="appWrap">

<!-- Header -->
<div class="hdr">
<div class="hdr-top">
<div>
<h1 id="pgTitle">SmartWallet AI</h1>
<div class="hdr-sub" id="pgSub">ÎŸ Ï€ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒÏ‚ ÏƒÎ¿Ï… Î¿Î¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÏŒÏ‚ Î²Î¿Î·Î¸ÏŒÏ‚</div>
</div>
<div class="usr-chip" onclick="go('pgSet',document.querySelector('[data-pg=pgSet]'))">
<div class="db-badge live" id="dbBadge"><span class="db-dot"></span><span id="dbText">Live</span></div>
<div class="usr-ava-placeholder">ğŸ‘¤</div>
</div>
</div>
</div>

<!-- Dashboard -->
<div class="pg on" id="pgDash">
<div class="bal-c c">
<div class="c-t">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿</div>
<div class="bal-n pos" id="balNum">0,00â‚¬</div>
<div class="bal-l" id="balLbl">Î±Ï€ÏŒ 0,00â‚¬ ÎµÎ¹ÏƒÏŒÎ´Î·Î¼Î±</div>
</div>

<!-- Quick Add (dynamic) -->
<div class="qa-row" id="qaRow"></div>

<!-- Bills Checklist -->
<div class="c" id="billsCard">
<div class="c-t">Î Î¬Î³Î¹Î± ÎˆÎ¾Î¿Î´Î± ÎœÎ®Î½Î±</div>
<div id="billsList"></div>
</div>

<div class="st-row">
<div class="st-card"><div class="st-lbl">Î•Î²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿</div><div class="st-val" id="wkVal" style="color:var(--blue)">0â‚¬</div></div>
<div class="st-card"><div class="st-lbl">Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿</div><div class="st-val" id="dyVal" style="color:var(--teal)">0â‚¬</div></div>
<div class="st-card"><div class="st-lbl">Î—Î¼Î­ÏÎµÏ‚</div><div class="st-val" id="dLeft" style="color:var(--orange)">0</div></div>
</div>
<div id="tipBox"></div>
<div class="c"><div class="c-t">ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î•Î¾ÏŒÎ´Ï‰Î½</div><div id="progBars"></div></div>
<div class="c"><div class="c-t">Î ÏÏŒÏƒÏ†Î±Ï„ÎµÏ‚ Î£Ï…Î½Î±Î»Î»Î±Î³Î­Ï‚</div><div id="recTx"></div></div>
</div>

<!-- Transactions -->
<div class="pg" id="pgTx">
<div class="search-wrap">
<span class="search-icon">ğŸ”</span>
<input type="text" class="search-fi" id="txSearch" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÏ…Î½Î±Î»Î»Î±Î³ÏÎ½..." oninput="renderTxPage()">
</div>
<div class="c"><div class="c-t">ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î£Ï…Î½Î±Î»Î»Î±Î³Î­Ï‚</div><div id="allTx"></div></div>
</div>

<!-- Statistics -->
<div class="pg" id="pgStats">
<div class="chart-section">
<div class="chart-title">Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· Î¤ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ vs Î ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿Ï…</div>
<div class="cmp-row" id="cmpRow"></div>
</div>
<div class="chart-section c">
<div class="c-t">ÎˆÎ¾Î¿Î´Î± Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Ï‰Î½ 6 ÎœÎ·Î½ÏÎ½</div>
<div class="bar-chart" id="barChart"></div>
</div>
<div class="chart-section c">
<div class="c-t">Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</div>
<div id="catBreakdown"></div>
</div>
<div class="chart-section c">
<div class="c-t">Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· Î±Î½Î¬ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± (vs Î ÏÎ¿Î·Î³. ÎœÎ®Î½Î±)</div>
<div id="catCompare"></div>
</div>
<div class="chart-section" id="aiInsightsSection">
<div class="chart-title">ğŸ¤– AI Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎœÎ®Î½Î±</div>
<div id="aiInsights"></div>
</div>
</div>

<!-- Settings -->
<div class="pg" id="pgSet">
<div class="ss">
<div class="ss-t">Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚</div>
<div class="logout-row">
<div class="usr-ava-placeholder" style="width:44px;height:44px;font-size:20px;flex-shrink:0">ğŸ‘¤</div>
<div class="logout-info">
<div class="logout-name" id="setName">â€”</div>
<div class="logout-email" id="setEmail">â€”</div>
</div>
<button class="logout-btn" onclick="doLogout()">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
</div>
</div>

<div class="ss">
<div class="ss-t">ÎœÎ·Î½Î¹Î±Î¯Î¿ Î•Î¹ÏƒÏŒÎ´Î·Î¼Î±</div>
<div class="sr"><span class="sr-l">Î•Î¹ÏƒÏŒÎ´Î·Î¼Î±</span><div style="display:flex;align-items:center"><input type="number" class="sr-i" id="sInc" inputmode="decimal"><span class="sr-s">â‚¬</span></div></div>
</div>
<div class="ss">
<div class="ss-t">Î£Ï„ÏŒÏ‡Î¿Ï‚ Î‘Ï€Î¿Ï„Î±Î¼Î¯ÎµÏ…ÏƒÎ·Ï‚</div>
<div class="sr"><span class="sr-l">Î‘Ï€Î¿Ï„Î±Î¼Î¯ÎµÏ…ÏƒÎ·</span><div style="display:flex;align-items:center"><input type="number" class="sr-i" id="sSav" inputmode="decimal"><span class="sr-s">â‚¬</span></div></div>
</div>
<div class="ss">
<div class="ss-t">Î Î¬Î³Î¹Î± ÎˆÎ¾Î¿Î´Î±</div>
<div id="billsManageList"></div>
<div class="bill-add-row" id="billAddRow" style="display:none">
<input type="text" class="fi sm" id="billNewIcon" placeholder="ğŸ " maxlength="2">
<input type="text" class="fi" id="billNewName" placeholder="ÎŒÎ½Î¿Î¼Î±" style="flex:1">
<input type="number" class="fi sm" id="billNewAmt" placeholder="â‚¬" inputmode="decimal" style="width:80px">
<button class="btn btn-g" onclick="saveNewBill()" style="width:auto;padding:10px 16px;flex-shrink:0">âœ“</button>
</div>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn btn-s" id="billAddBtn" onclick="toggleBillForm(true)">+ ÎÎ­Î¿ Î Î¬Î³Î¹Î¿</button>
<button class="btn btn-s" id="billCancelBtn" onclick="toggleBillForm(false)" style="display:none">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
</div>
</div>
<div class="ss">
<div class="ss-t">Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯</div>
<div class="sr"><span class="sr-l">Î£Î¿ÏÏ€ÎµÏ ÎœÎ¬ÏÎºÎµÏ„</span><div style="display:flex;align-items:center"><input type="number" class="sr-i" id="sSup" inputmode="decimal"><span class="sr-s">â‚¬</span></div></div>
</div>

<!-- Quick Add Management -->
<div class="ss">
<div class="ss-t">Î“ÏÎ®Î³Î¿ÏÎ± ÎšÎ¿Ï…Î¼Ï€Î¹Î¬</div>
<div id="qaManageList"></div>
<div class="qa-add-form" id="qaAddForm" style="display:none">
<div class="qa-add-row">
<input type="text" class="fi sm" id="qaNewIcon" placeholder="ğŸ˜€" maxlength="2">
<input type="text" class="fi" id="qaNewName" placeholder="ÎŒÎ½Î¿Î¼Î±" style="flex:1">
<input type="number" class="fi sm" id="qaNewAmt" placeholder="â‚¬" inputmode="decimal" style="width:70px">
</div>
<div class="qa-add-type-row">
<button class="qa-add-type-btn sel-exp" id="qaTypeExp" onclick="setQaType('expense')">ÎˆÎ¾Î¿Î´Î¿</button>
<button class="qa-add-type-btn" id="qaTypeInc" onclick="setQaType('income')">ÎˆÏƒÎ¿Î´Î¿</button>
</div>
<div class="fg" id="qaNewCatWrap">
<label class="fl">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</label>
<div class="cg" id="qaNewCatG"></div>
</div>
<div style="display:flex;gap:8px">
<button class="btn btn-g" onclick="saveNewQa()" style="flex:1">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
<button class="btn btn-s" onclick="toggleQaForm(false)" style="flex:1">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
</div>
</div>
<button class="btn btn-s" id="qaAddBtn" onclick="toggleQaForm(true)" style="margin-top:8px">+ ÎÎ­Î¿ ÎšÎ¿Ï…Î¼Ï€Î¯</button>
</div>

<!-- Shared Wallet -->
<div class="ss">
<div class="ss-t">ÎšÎ¿Î¹Î½ÏŒ Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹</div>
<div id="swStatus"></div>
<div id="swActions"></div>
</div>

<!-- CSV Export -->
<div class="ss">
<div class="ss-t">Î•Î¾Î±Î³Ï‰Î³Î® Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½</div>
<button class="btn btn-s" onclick="exportCSV()" style="margin-bottom:8px">ğŸ“¥ Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
</div>

<button class="btn btn-b" id="saveBtn" onclick="saveSettings()">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¡Ï…Î¸Î¼Î¯ÏƒÎµÏ‰Î½</button>

<div class="ss" style="margin-top:24px">
<div class="ss-t">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ / Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬</div>
<button class="btn btn-s" onclick="clearMonthTx()" style="margin-bottom:8px">ğŸ—“ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏƒÏ…Î½Î±Î»Î»Î±Î³ÏÎ½ Î¼Î®Î½Î±</button>
<button class="btn btn-s" onclick="clearAllTx()" style="margin-bottom:8px">ğŸ§¹ Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ ÏƒÏ…Î½Î±Î»Î»Î±Î³ÏÎ½</button>
<button class="btn btn-s" onclick="resetBillsMonth()" style="margin-bottom:8px">ğŸ”„ Reset Ï€Î¬Î³Î¹Î± Î¼Î®Î½Î± (Î•ÎºÎºÏÎµÎ¼ÎµÎ¯)</button>
<button class="rst" onclick="confirmReset()">ğŸ’£ Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎŒÎ»Ï‰Î½ (ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ + Î´ÎµÎ´Î¿Î¼Î­Î½Î±)</button>
</div>
<div class="ver">SmartWallet AI v5.2<br>Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÎ¿Ï…, Ï€Î±Î½Ï„Î¿Ï, Ï€Î¬Î½Ï„Î±.</div>
</div>

<!-- FAB -->
<button class="fab" id="fab" onclick="openModal()">+</button>

<!-- Nav -->
<nav class="nav">
<button class="nav-i on" data-pg="pgDash" onclick="go('pgDash',this)"><span class="nav-ic">ğŸ“Š</span>Î‘ÏÏ‡Î¹ÎºÎ®</button>
<button class="nav-i" data-pg="pgTx" onclick="go('pgTx',this)"><span class="nav-ic">ğŸ“‹</span>Î£Ï…Î½Î±Î»Î»Î±Î³Î­Ï‚</button>
<button class="nav-i" data-pg="pgStats" onclick="go('pgStats',this)"><span class="nav-ic">ğŸ“ˆ</span>Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬</button>
<button class="nav-i" data-pg="pgSet" onclick="go('pgSet',this)"><span class="nav-ic">âš™ï¸</span>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
</nav>
</div>

<!-- Add Modal -->
<div class="mo" id="addMo">
<div class="mo-s">
<div class="mo-h"></div>
<div class="mo-t" id="moTitle">ÎÎ­Î± Î£Ï…Î½Î±Î»Î»Î±Î³Î®</div>

<!-- Type toggle -->
<div class="type-tog">
<button class="type-btn sel-exp" id="typeBtnExp" onclick="setTxType('expense')">ÎˆÎ¾Î¿Î´Î¿</button>
<button class="type-btn" id="typeBtnInc" onclick="setTxType('income')">ÎˆÏƒÎ¿Î´Î¿</button>
</div>

<div class="fg"><label class="fl">Î Î¿ÏƒÏŒ (â‚¬)</label><input type="number" class="fi" id="txAmt" placeholder="Ï€.Ï‡. 25.50" inputmode="decimal" step="0.01"></div>
<div class="fg"><label class="fl">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</label><input type="text" class="fi" id="txDsc" placeholder="Ï€.Ï‡. ÎšÎ±Ï†Î­Ï‚ Î¼Îµ Ï†Î¯Î»Î¿Ï…Ï‚" autocomplete="off"></div>
<div class="fg" id="catWrap">
<label class="fl">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</label>
<div class="cg" id="catG">
<div class="ct" data-c="food" onclick="selCat(this)">ğŸ• Î¦Î±Î³Î·Ï„ÏŒ</div>
<div class="ct" data-c="super" onclick="selCat(this)">ğŸ›’ Î£Î¿ÏÏ€ÎµÏ ÎœÎ¬ÏÎºÎµÏ„</div>
<div class="ct" data-c="transport" onclick="selCat(this)">ğŸš— ÎœÎµÏ„Î±Ï†Î¿ÏÎ¹ÎºÎ¬</div>
<div class="ct" data-c="ent" onclick="selCat(this)">ğŸ¬ Î¨Ï…Ï‡Î±Î³Ï‰Î³Î¯Î±</div>
<div class="ct" data-c="shop" onclick="selCat(this)">ğŸ›ï¸ Î‘Î³Î¿ÏÎ­Ï‚</div>
<div class="ct" data-c="health" onclick="selCat(this)">ğŸ’Š Î¥Î³ÎµÎ¯Î±</div>
<div class="ct" data-c="bills" onclick="selCat(this)">ğŸ“„ Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯</div>
<div class="ct" data-c="other" onclick="selCat(this)">ğŸ“Œ Î†Î»Î»Î¿</div>
</div>
</div>
<button class="btn btn-g" id="txSubmitBtn" onclick="addTx()">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•Î¾ÏŒÎ´Î¿Ï…</button>
<button class="btn btn-s" style="margin-top:10px" onclick="closeMo()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
</div>
</div>

<!-- Confirm -->
<div class="cfm" id="cfmOv">
<div class="cfm-b">
<div class="cfm-m" id="cfmMsg"></div>
<div class="cfm-r">
<button class="btn btn-s" onclick="closeCfm()">ÎŒÏ‡Î¹</button>
<button class="btn btn-r" id="cfmYes">ÎÎ±Î¹</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, doc, addDoc, deleteDoc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA0O8vfoMvMeyEJltU3QWfxT3_dIJpirLs",
  authDomain: "my-wallet-app-c4fb6.firebaseapp.com",
  projectId: "my-wallet-app-c4fb6",
  storageBucket: "my-wallet-app-c4fb6.firebasestorage.app",
  messagingSenderId: "233595751510",
  appId: "1:233595751510:web:1e3dcfaebeb6c66feb7ff7",
  measurementId: "G-GTDED0H3EX"
};

const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);
let isLoginMode = true;

// â”€â”€ State â”€â”€
const CATS={food:{label:'Î¦Î±Î³Î·Ï„ÏŒ',icon:'ğŸ•',css:'cc-food'},super:{label:'Î£Î¿ÏÏ€ÎµÏ ÎœÎ¬ÏÎºÎµÏ„',icon:'ğŸ›’',css:'cc-super'},
transport:{label:'ÎœÎµÏ„Î±Ï†Î¿ÏÎ¹ÎºÎ¬',icon:'ğŸš—',css:'cc-transport'},ent:{label:'Î¨Ï…Ï‡Î±Î³Ï‰Î³Î¯Î±',icon:'ğŸ¬',css:'cc-ent'},
shop:{label:'Î‘Î³Î¿ÏÎ­Ï‚',icon:'ğŸ›ï¸',css:'cc-shop'},health:{label:'Î¥Î³ÎµÎ¯Î±',icon:'ğŸ’Š',css:'cc-health'},
bills:{label:'Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯',icon:'ğŸ“„',css:'cc-bills'},other:{label:'Î†Î»Î»Î¿',icon:'ğŸ“Œ',css:'cc-other'},
income:{label:'ÎˆÏƒÎ¿Î´Î¿',icon:'ğŸ’µ',css:'cc-income'}};

const DEFAULT_QA=[
  {icon:'â˜•',name:'ÎšÎ±Ï†Î­Ï‚',cat:'food',amount:2,type:'expense'},
  {icon:'â›½',name:'Î’ÎµÎ½Î¶Î¯Î½Î·',cat:'transport',amount:20,type:'expense'},
  {icon:'ğŸš¬',name:'Î¤ÏƒÎ¹Î³Î¬ÏÎ±',cat:'other',amount:5,type:'expense'},
  {icon:'ğŸ”',name:'Î¦Î±Î³Î·Ï„ÏŒ',cat:'food',amount:10,type:'expense'},
  {icon:'ğŸ›’',name:'Î£Î¿ÏÏ€ÎµÏ',cat:'super',amount:30,type:'expense'}
];

const DEFAULT_BILLS=[
  {id:'rent',name:'Î•Î½Î¿Î¯ÎºÎ¹Î¿',icon:'ğŸ ',amount:0,cat:'bills'},
  {id:'loan',name:'Î”Î¬Î½ÎµÎ¹Î¿',icon:'ğŸ¦',amount:0,cat:'bills'},
  {id:'gym',name:'Î“Ï…Î¼Î½Î±ÏƒÏ„Î®ÏÎ¹Î¿',icon:'ğŸ’ª',amount:0,cat:'health'}
];

// New users start with zeros â€” they fill in their own values
const DEF={income:0,savings:0,rent:0,loan:0,gym:0,supermarket:0,lastRecurringMonth:'',walletId:'',quickAdds:DEFAULT_QA,fixedBills:DEFAULT_BILLS,paidBills:{}};
let settings={...DEF,quickAdds:[...DEFAULT_QA],fixedBills:[...DEFAULT_BILLS],paidBills:{}};
let transactions=[];
let selCategory=null;
let txType='expense'; // current modal type
let qaNewType='expense'; // quick-add form type
let qaNewCat=null;
let cfmCb=null;
let currentUser=null;
let unsubTx=null;
let unsubSet=null;
let activeWalletId='';

const $=id=>document.getElementById(id);
const fmt=n=>n.toLocaleString('el-GR',{minimumFractionDigits:2,maximumFractionDigits:2})+'â‚¬';
const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};
const now=()=>new Date();
const dim=()=>new Date(now().getFullYear(),now().getMonth()+1,0).getDate();
const dleft=()=>Math.max(0,dim()-now().getDate());
const wleft=()=>Math.max(1,Math.ceil(dleft()/7));
const dleftN=()=>Math.max(1,dleft()||1);

// â”€â”€ Calculation helpers (income-aware) â”€â”€
function mTx(){const n=now(),y=n.getFullYear(),m=n.getMonth();
return transactions.filter(t=>{const d=new Date(t.date);return d.getFullYear()===y&&d.getMonth()===m});}

function mExpenses(){return mTx().filter(t=>t.type!=='income');}
function mIncomes(){return mTx().filter(t=>t.type==='income');}
function tSpent(){return mExpenses().reduce((s,t)=>s+t.amount,0);}
function tExtraIncome(){return mIncomes().reduce((s,t)=>s+t.amount,0);}
function totalIncome(){return settings.income+tExtraIncome();}
function cSum(c){return mExpenses().filter(t=>t.category===c).reduce((s,t)=>s+t.amount,0);}
// All bills INCLUDING savings as a bill
function allBills(){
  const bills=[...(settings.fixedBills||[])];
  if(settings.savings>0) bills.push({id:'savings',name:'Î‘Ï€Î¿Ï„Î±Î¼Î¯ÎµÏ…ÏƒÎ·',icon:'ğŸ’°',amount:settings.savings,cat:'other'});
  return bills;
}
// Only count UNPAID bills â€” paid ones are already in tSpent() as transactions
function fixed(){
  return allBills().filter(b=>b.amount>0 && !isBillPaid(b.id)).reduce((s,b)=>s+b.amount,0);
}
// Total of ALL bills (for display)
function fixedAll(){
  return allBills().reduce((s,b)=>s+(b.amount||0),0);
}
// No more separate "- settings.savings" â€” savings is inside fixed() now
function safe(){return totalIncome()-fixed()-tSpent();}

// Month-specific helpers
function txForMonth(year,month){
return transactions.filter(t=>{const d=new Date(t.date);return d.getFullYear()===year&&d.getMonth()===month;});}
function expensesForMonth(year,month){return txForMonth(year,month).filter(t=>t.type!=='income');}
function spentForMonth(year,month){return expensesForMonth(year,month).reduce((s,t)=>s+t.amount,0);}
function catSumForMonth(cat,year,month){return expensesForMonth(year,month).filter(t=>t.category===cat).reduce((s,t)=>s+t.amount,0);}

function fDate(d){const dt=new Date(d);
const mo=['Î™Î±Î½','Î¦ÎµÎ²','ÎœÎ±Ï','Î‘Ï€Ï','ÎœÎ±Î','Î™Î¿Ï…Î½','Î™Î¿Ï…Î»','Î‘Ï…Î³','Î£ÎµÏ€','ÎŸÎºÏ„','ÎÎ¿Îµ','Î”ÎµÎº'];
const dy=['ÎšÏ…Ï','Î”ÎµÏ…','Î¤ÏÎ¹','Î¤ÎµÏ„','Î ÎµÎ¼','Î Î±Ï','Î£Î±Î²'];
return `${dy[dt.getDay()]}, ${dt.getDate()} ${mo[dt.getMonth()]}`;}
function fTime(d){const dt=new Date(d);return dt.getHours().toString().padStart(2,'0')+':'+dt.getMinutes().toString().padStart(2,'0');}
const MONTH_NAMES=['Î™Î±Î½','Î¦ÎµÎ²','ÎœÎ±Ï','Î‘Ï€Ï','ÎœÎ±Î','Î™Î¿Ï…Î½','Î™Î¿Ï…Î»','Î‘Ï…Î³','Î£ÎµÏ€','ÎŸÎºÏ„','ÎÎ¿Îµ','Î”ÎµÎº'];

// â”€â”€ Toast â”€â”€
let toastT;
function toast(m,t='inf'){const e=$('toast');e.textContent=m;e.className='toast '+t;
clearTimeout(toastT);requestAnimationFrame(()=>{e.classList.add('show');toastT=setTimeout(()=>e.classList.remove('show'),2500);});}

// â”€â”€ Nav â”€â”€
window.go=(p,b)=>{document.querySelectorAll('.pg').forEach(x=>x.classList.remove('on'));
$(p).classList.add('on');document.querySelectorAll('.nav-i').forEach(x=>x.classList.remove('on'));
if(b)b.classList.add('on');
const t={pgDash:['SmartWallet AI','ÎŸ Ï€ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒÏ‚ ÏƒÎ¿Ï… Î¿Î¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÏŒÏ‚ Î²Î¿Î·Î¸ÏŒÏ‚'],
pgTx:['Î£Ï…Î½Î±Î»Î»Î±Î³Î­Ï‚','Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎµÎ¾ÏŒÎ´Ï‰Î½'],pgStats:['Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬','Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎµÎ¾ÏŒÎ´Ï‰Î½'],pgSet:['Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚','Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï']};
const v=t[p]||t.pgDash;$('pgTitle').textContent=v[0];$('pgSub').textContent=v[1];
$('fab').style.display=(p==='pgSet'||p==='pgStats')?'none':'flex';
if(p==='pgStats') renderStats();
};

// â”€â”€ Modal â”€â”€
window.openModal=()=>{
  $('txAmt').value='';$('txDsc').value='';selCategory=null;txType='expense';
  document.querySelectorAll('#catG .ct').forEach(t=>t.classList.remove('sel'));
  $('typeBtnExp').className='type-btn sel-exp';
  $('typeBtnInc').className='type-btn';
  $('catWrap').style.display='';
  $('txSubmitBtn').textContent='Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•Î¾ÏŒÎ´Î¿Ï…';
  $('txSubmitBtn').className='btn btn-g';
  $('moTitle').textContent='ÎÎ­Î± Î£Ï…Î½Î±Î»Î»Î±Î³Î®';
  $('addMo').classList.add('open');
};
window.closeMo=()=>$('addMo').classList.remove('open');
$('addMo').addEventListener('click',e=>{if(e.target===$('addMo'))window.closeMo();});
window.selCat=el=>{document.querySelectorAll('#catG .ct').forEach(t=>t.classList.remove('sel'));el.classList.add('sel');selCategory=el.dataset.c;};

// â”€â”€ Type toggle in modal â”€â”€
window.setTxType=(type)=>{
  txType=type;
  if(type==='expense'){
    $('typeBtnExp').className='type-btn sel-exp';
    $('typeBtnInc').className='type-btn';
    $('catWrap').style.display='';
    $('txSubmitBtn').textContent='Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•Î¾ÏŒÎ´Î¿Ï…';
    $('txSubmitBtn').className='btn btn-g';
    $('txDsc').placeholder='Ï€.Ï‡. ÎšÎ±Ï†Î­Ï‚ Î¼Îµ Ï†Î¯Î»Î¿Ï…Ï‚';
  } else {
    $('typeBtnExp').className='type-btn';
    $('typeBtnInc').className='type-btn sel-inc';
    $('catWrap').style.display='none';
    selCategory='income';
    $('txSubmitBtn').textContent='Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•ÏƒÏŒÎ´Î¿Ï…';
    $('txSubmitBtn').className='btn btn-g';
    $('txSubmitBtn').style.background='var(--green)';
    $('txDsc').placeholder='Ï€.Ï‡. Î£Ï„Î¿Î¯Ï‡Î·Î¼Î±, Freelance, Î”ÏÏÎ¿';
  }
};

// â”€â”€ Shake â”€â”€
const shk=document.createElement('style');
shk.textContent='@keyframes shk{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}';
document.head.appendChild(shk);
function shake(id){const e=$(id);e.style.borderColor='var(--red)';e.style.animation='none';
e.offsetHeight;e.style.animation='shk .4s ease';setTimeout(()=>{e.style.borderColor='';e.style.animation=''},500);}

// â”€â”€ Confirm â”€â”€
window.closeCfm=()=>{$('cfmOv').classList.remove('open');cfmCb=null;};
function showCfm(m,cb){$('cfmMsg').textContent=m;cfmCb=cb;$('cfmOv').classList.add('open');}
$('cfmYes').addEventListener('click',()=>{if(cfmCb)cfmCb();window.closeCfm();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE PATH HELPERS (wallet-aware)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function txCol(){
  if(activeWalletId) return collection(db,'wallets',activeWalletId,'transactions');
  return collection(db,'users',currentUser.uid,'transactions');
}
function txDocRef(id){
  if(activeWalletId) return doc(db,'wallets',activeWalletId,'transactions',id);
  return doc(db,'users',currentUser.uid,'transactions',id);
}
function settingsRef(){
  if(activeWalletId) return doc(db,'wallets',activeWalletId,'settings','config');
  return doc(db,'users',currentUser.uid,'settings','config');
}
function userDoc(uid,path){return doc(db,'users',uid,...path.split('/'));}
function userCol(uid,col){return collection(db,'users',uid,col);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUTH_ERRORS = {
  'auth/email-already-in-use':'Î‘Ï…Ï„ÏŒ Ï„Î¿ email Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î®Î´Î·.',
  'auth/weak-password':'ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 6 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.',
  'auth/invalid-email':'ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ email.',
  'auth/user-not-found':'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Î¼Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ email.',
  'auth/wrong-password':'Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚.',
  'auth/invalid-credential':'Î›Î¬Î¸Î¿Ï‚ email Î® ÎºÏ‰Î´Î¹ÎºÏŒÏ‚.',
  'auth/too-many-requests':'Î Î¿Î»Î»Î­Ï‚ Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹ÎµÏ‚. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î±ÏÎ³ÏŒÏ„ÎµÏÎ±.',
  'auth/missing-password':'Î’Î¬Î»Îµ ÎºÏ‰Î´Î¹ÎºÏŒ.',
  'auth/missing-email':'Î’Î¬Î»Îµ email.'
};

window.toggleAuthMode = () => {
  isLoginMode = !isLoginMode;
  $('authBtn').textContent = isLoginMode ? 'Î£ÏÎ½Î´ÎµÏƒÎ·' : 'Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï';
  $('authSwitch').innerHTML = isLoginMode
    ? 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ; <strong>Î•Î³Î³ÏÎ±Ï†Î®</strong>'
    : 'ÎˆÏ‡ÎµÎ¹Ï‚ Î®Î´Î· Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ; <strong>Î£ÏÎ½Î´ÎµÏƒÎ·</strong>';
  $('authErr').textContent = '';
};

window.doAuth = async () => {
  const email = $('authEmail').value.trim();
  const pass = $('authPass').value;
  $('authErr').textContent = '';
  if(!email){$('authErr').textContent='Î’Î¬Î»Îµ Ï„Î¿ email ÏƒÎ¿Ï….';shake('authEmail');return;}
  if(!pass){$('authErr').textContent='Î’Î¬Î»Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÏƒÎ¿Ï….';shake('authPass');return;}
  $('authBtn').textContent = 'Î ÎµÏÎ¯Î¼ÎµÎ½Îµ...';
  $('authBtn').style.opacity = '0.6';
  try {
    if(isLoginMode) await signInWithEmailAndPassword(auth, email, pass);
    else await createUserWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    $('authErr').textContent = AUTH_ERRORS[e.code] || 'Î£Ï†Î¬Î»Î¼Î±: ' + e.message;
    $('authBtn').textContent = isLoginMode ? 'Î£ÏÎ½Î´ÎµÏƒÎ·' : 'Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï';
    $('authBtn').style.opacity = '1';
  }
};

$('authPass').addEventListener('keydown', e => { if(e.key==='Enter') window.doAuth(); });
$('authEmail').addEventListener('keydown', e => { if(e.key==='Enter') $('authPass').focus(); });

window.doLogout = async ()=>{
  showCfm('Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ;', async ()=>{
    if(unsubTx) unsubTx();
    if(unsubSet) unsubSet();
    transactions=[];settings={...DEF,quickAdds:[...DEFAULT_QA],fixedBills:[...DEFAULT_BILLS],paidBills:{}};activeWalletId='';
    await signOut(auth);
  });
};

onAuthStateChanged(auth, user => {
  if(user) {
    currentUser = user;
    $('loginScr').classList.add('hide');
    $('appWrap').classList.add('show');
    $('loadScr').classList.remove('hide');
    $('loadScr').style.display='flex';
    $('setName').textContent=user.email.split('@')[0];
    $('setEmail').textContent=user.email;
    initUser(user.uid);
  } else {
    currentUser = null;
    $('loginScr').classList.remove('hide');
    $('appWrap').classList.remove('show');
    $('authBtn').textContent = isLoginMode ? 'Î£ÏÎ½Î´ÎµÏƒÎ·' : 'Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï';
    $('authBtn').style.opacity = '1';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT USER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initUser(uid){
  const personalRef = userDoc(uid,'settings/config');
  try {
    const snap = await getDoc(personalRef);
    if(snap.exists() && snap.data().walletId){
      activeWalletId = snap.data().walletId;
    } else {
      activeWalletId = '';
    }
  } catch(e){ activeWalletId=''; }
  startListeners(uid);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startListeners(uid) {
  if(unsubTx) unsubTx();
  if(unsubSet) unsubSet();

  const tq = query(txCol(), orderBy('date','desc'));
  unsubTx = onSnapshot(tq, snap=>{
    transactions = snap.docs.map(d=>({id:d.id,...d.data()}));
    // Ensure all transactions have type field (backward compat)
    transactions.forEach(t=>{ if(!t.type) t.type='expense'; });
    renderAll();
    hideLoading();
  }, err=>{
    console.error('TX err:',err);
    $('dbBadge').className='db-badge off';$('dbText').textContent='Î£Ï†Î¬Î»Î¼Î±';
    hideLoading();
  });

  const sRef = settingsRef();
  unsubSet = onSnapshot(sRef, snap=>{
    if(snap.exists()){
      const data = snap.data();
      settings={...DEF,...data};
      if(!Array.isArray(settings.quickAdds)) settings.quickAdds=[...DEFAULT_QA];
      settings.quickAdds.forEach(q=>{ if(!q.type) q.type='expense'; });
      // Migrate old rent/loan/gym to fixedBills if no fixedBills yet
      if(!Array.isArray(settings.fixedBills)){
        settings.fixedBills = [
          {id:'rent',name:'Î•Î½Î¿Î¯ÎºÎ¹Î¿',icon:'ğŸ ',amount:settings.rent||0,cat:'bills'},
          {id:'loan',name:'Î”Î¬Î½ÎµÎ¹Î¿',icon:'ğŸ¦',amount:settings.loan||0,cat:'bills'},
          {id:'gym',name:'Î“Ï…Î¼Î½Î±ÏƒÏ„Î®ÏÎ¹Î¿',icon:'ğŸ’ª',amount:settings.gym||0,cat:'health'}
        ].filter(b=>b.amount>0);
        if(!settings.fixedBills.length) settings.fixedBills=[...DEFAULT_BILLS];
      }
      if(!settings.paidBills || typeof settings.paidBills!=='object') settings.paidBills={};
    } else {
      settings={...DEF,quickAdds:[...DEFAULT_QA],fixedBills:[...DEFAULT_BILLS],paidBills:{}};
      setDoc(sRef,{...DEF,quickAdds:DEFAULT_QA,fixedBills:DEFAULT_BILLS,paidBills:{}}).catch(()=>{});
    }
    fillSettings();
    renderAll();
    renderSharedWalletUI();
    renderQaManage();
    renderBillsManage();
  });
}

function hideLoading(){
  $('dbBadge').className='db-badge live';$('dbText').textContent='Live';
  $('loadScr').classList.add('hide');
  setTimeout(()=>{$('loadScr').style.display='none';},400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BILLS CHECKLIST (paid/pending)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function currentMonthKey(){
  const n=now();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
}

function isBillPaid(billId){
  const key=currentMonthKey();
  const paid=settings.paidBills||{};
  return Array.isArray(paid[key]) && paid[key].includes(billId);
}

function renderBills(){
  const bills=allBills().filter(b=>b.amount>0);
  if(!bills.length){
    $('billsCard').style.display='none';
    return;
  }
  $('billsCard').style.display='';

  const paidCount=bills.filter(b=>isBillPaid(b.id)).length;
  const totalCount=bills.length;

  let h=`<div style="font-size:12px;color:var(--text2);margin-bottom:8px">${paidCount}/${totalCount} Ï€Î»Î·ÏÏÎ¸Î·ÎºÎ±Î½</div>`;
  bills.forEach(b=>{
    const paid=isBillPaid(b.id);
    h+=`<div class="bill-item" onclick="${paid?'':'payBill(\''+b.id+'\')'}" style="${paid?'opacity:.7;cursor:default':''}">
      <div class="bill-ico">${b.icon||'ğŸ“„'}</div>
      <div class="bill-info">
        <div class="bill-name">${esc(b.name)}</div>
        <div class="bill-amt">${fmt(b.amount)}</div>
      </div>
      <div class="bill-status ${paid?'paid':'pending'}">${paid?'âœ“ Î Î»Î·ÏÏÎ¸Î·ÎºÎµ':'Î•ÎºÎºÏÎµÎ¼ÎµÎ¯'}</div>
    </div>`;
  });
  $('billsList').innerHTML=h;
}

window.payBill = (billId)=>{
  const bill=allBills().find(b=>b.id===billId);
  if(!bill||!currentUser) return;
  showCfm(`Î Î»Î®ÏÏ‰ÏƒÎµÏ‚ "${bill.name}" (${fmt(bill.amount)});`, async()=>{
    try{
      // Create transaction
      await addDoc(txCol(),{
        amount:bill.amount, description:bill.name, category:bill.cat||'bills',
        date:now().toISOString(), createdAt:Date.now(),
        recurring:true, type:'expense'
      });
      // Mark as paid
      const key=currentMonthKey();
      const paid={...(settings.paidBills||{})};
      if(!Array.isArray(paid[key])) paid[key]=[];
      paid[key].push(billId);
      await updateDoc(settingsRef(),{paidBills:paid});
      toast(`${bill.name} Ï€Î»Î·ÏÏÎ¸Î·ÎºÎµ!`,'ok');
    }catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');console.error(e);}
  });
};

// Bills management in settings
function renderBillsManage(){
  const bills=settings.fixedBills||[];
  let h='';
  bills.forEach((b,i)=>{
    h+=`<div class="qa-item">
      <div class="qa-item-ico">${b.icon||'ğŸ“„'}</div>
      <div class="qa-item-info">${esc(b.name)}</div>
      <div class="qa-item-amt expense">${b.amount>0?fmt(b.amount):'0â‚¬'}</div>
      <button class="qa-item-del" onclick="removeBill(${i})">âœ•</button>
    </div>`;
  });
  $('billsManageList').innerHTML=h||'<div style="color:var(--text2);font-size:13px;padding:8px 0">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î¬Î³Î¹Î± Î±ÎºÏŒÎ¼Î±.</div>';
}

window.toggleBillForm=(show)=>{
  $('billAddRow').style.display=show?'flex':'none';
  $('billAddBtn').style.display=show?'none':'';
  $('billCancelBtn').style.display=show?'':'none';
  if(show){$('billNewIcon').value='';$('billNewName').value='';$('billNewAmt').value='';}
};

window.saveNewBill=async()=>{
  if(!currentUser)return;
  const icon=$('billNewIcon').value.trim()||'ğŸ“„';
  const name=$('billNewName').value.trim();
  const amount=parseFloat($('billNewAmt').value);
  if(!name){toast('Î’Î¬Î»Îµ ÏŒÎ½Î¿Î¼Î±','err');return;}
  if(!amount||amount<=0){toast('Î’Î¬Î»Îµ Ï€Î¿ÏƒÏŒ','err');return;}
  const id='bill_'+Date.now();
  const bills=[...(settings.fixedBills||[])];
  bills.push({id,name,icon,amount,cat:'bills'});
  try{
    await updateDoc(settingsRef(),{fixedBills:bills});
    toast('Î Î¬Î³Î¹Î¿ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!','ok');
    window.toggleBillForm(false);
  }catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');}
};

window.removeBill=async(idx)=>{
  if(!currentUser)return;
  const bills=[...(settings.fixedBills||[])];
  const name=bills[idx]?.name||'';
  showCfm(`Î‘Ï†Î±Î¯ÏÎµÏƒÎ· "${name}" Î±Ï€ÏŒ Ï„Î± Ï€Î¬Î³Î¹Î±;`,async()=>{
    bills.splice(idx,1);
    try{
      await updateDoc(settingsRef(),{fixedBills:bills});
      toast('Î Î¬Î³Î¹Î¿ Î±Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ','ok');
    }catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');}
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUICK ADD (dynamic from settings)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.quickAdd = async (desc, cat, amount, type) => {
  if(!currentUser) return;
  type = type || 'expense';
  try {
    await addDoc(txCol(), {
      amount: amount, description: desc, category: cat,
      date: now().toISOString(), createdAt: Date.now(),
      type: type
    });
    const sign = type==='income' ? '+' : '';
    toast(`${desc} ${sign}${amount}â‚¬ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!`,'ok');
  } catch(e){ toast('Î£Ï†Î¬Î»Î¼Î±','err'); console.error(e); }
};

function renderQuickAdds(){
  const qa = settings.quickAdds || [];
  if(!qa.length){ $('qaRow').innerHTML=''; return; }
  $('qaRow').innerHTML = qa.map((q,i)=>{
    const isInc = q.type==='income';
    const cls = isInc ? 'qa-btn inc' : 'qa-btn';
    const amtCls = isInc ? 'qa-amt income' : 'qa-amt expense';
    const prefix = isInc ? '+' : '';
    return `<button class="${cls}" onclick="quickAdd('${esc(q.name)}','${q.cat}',${q.amount},'${q.type}')">
      <span class="qa-ico">${q.icon}</span>
      <span class="${amtCls}">${prefix}${q.amount}â‚¬</span>
      ${esc(q.name)}
    </button>`;
  }).join('');
}

// â”€â”€ Quick Add management (settings) â”€â”€
function renderQaManage(){
  const qa = settings.quickAdds || [];
  let h = '';
  qa.forEach((q,i)=>{
    const isInc = q.type==='income';
    const amtCls = isInc ? 'qa-item-amt income' : 'qa-item-amt expense';
    const prefix = isInc ? '+' : '-';
    h += `<div class="qa-item">
      <div class="qa-item-ico">${q.icon}</div>
      <div class="qa-item-info">${esc(q.name)}</div>
      <div class="${amtCls}">${prefix}${q.amount}â‚¬</div>
      <button class="qa-item-del" onclick="removeQa(${i})">âœ•</button>
    </div>`;
  });
  $('qaManageList').innerHTML = h || '<div style="color:var(--text2);font-size:13px;padding:8px 0">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Î±ÎºÏŒÎ¼Î±.</div>';
}

window.removeQa = async (idx)=>{
  if(!currentUser) return;
  const qa = [...(settings.quickAdds||[])];
  qa.splice(idx, 1);
  try {
    await updateDoc(settingsRef(), { quickAdds: qa });
    toast('ÎšÎ¿Ï…Î¼Ï€Î¯ Î±Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ','ok');
  } catch(e){ toast('Î£Ï†Î¬Î»Î¼Î±','err'); }
};

window.toggleQaForm = (show)=>{
  $('qaAddForm').style.display = show ? 'block' : 'none';
  $('qaAddBtn').style.display = show ? 'none' : '';
  if(show){
    $('qaNewIcon').value='';$('qaNewName').value='';$('qaNewAmt').value='';
    qaNewType='expense'; qaNewCat=null;
    $('qaTypeExp').className='qa-add-type-btn sel-exp';
    $('qaTypeInc').className='qa-add-type-btn';
    renderQaCatPicker();
  }
};

window.setQaType = (type)=>{
  qaNewType = type;
  if(type==='expense'){
    $('qaTypeExp').className='qa-add-type-btn sel-exp';
    $('qaTypeInc').className='qa-add-type-btn';
    $('qaNewCatWrap').style.display='';
    qaNewCat=null;
  } else {
    $('qaTypeExp').className='qa-add-type-btn';
    $('qaTypeInc').className='qa-add-type-btn sel-inc';
    $('qaNewCatWrap').style.display='none';
    qaNewCat='income';
  }
};

function renderQaCatPicker(){
  const expCats = Object.entries(CATS).filter(([k])=>k!=='income');
  $('qaNewCatG').innerHTML = expCats.map(([k,v])=>
    `<div class="ct" data-c="${k}" onclick="selQaCat(this)">${v.icon} ${v.label}</div>`
  ).join('');
  $('qaNewCatWrap').style.display = qaNewType==='income' ? 'none' : '';
}

window.selQaCat = (el)=>{
  $('qaNewCatG').querySelectorAll('.ct').forEach(t=>t.classList.remove('sel'));
  el.classList.add('sel');
  qaNewCat = el.dataset.c;
};

window.saveNewQa = async ()=>{
  if(!currentUser) return;
  const icon = $('qaNewIcon').value.trim();
  const name = $('qaNewName').value.trim();
  const amount = parseFloat($('qaNewAmt').value);
  if(!icon){ toast('Î’Î¬Î»Îµ Î­Î½Î± emoji','err'); return; }
  if(!name){ toast('Î’Î¬Î»Îµ ÏŒÎ½Î¿Î¼Î±','err'); return; }
  if(!amount || amount<=0){ toast('Î’Î¬Î»Îµ Ï€Î¿ÏƒÏŒ','err'); return; }
  if(qaNewType==='expense' && !qaNewCat){ toast('Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±','err'); return; }
  const cat = qaNewType==='income' ? 'income' : qaNewCat;

  const qa = [...(settings.quickAdds||[])];
  qa.push({icon, name, cat, amount, type: qaNewType});

  try {
    await updateDoc(settingsRef(), { quickAdds: qa });
    toast('ÎšÎ¿Ï…Î¼Ï€Î¯ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!','ok');
    window.toggleQaForm(false);
  } catch(e){ toast('Î£Ï†Î¬Î»Î¼Î±','err'); }
};

// â”€â”€ Add TX (modal) â”€â”€
window.addTx = async ()=>{
  if(!currentUser)return;
  const amt=parseFloat($('txAmt').value);
  const dsc=$('txDsc').value.trim();
  if(!amt||amt<=0){shake('txAmt');return;}
  if(!dsc){shake('txDsc');return;}
  if(txType==='expense' && !selCategory){
    const g=$('catG');g.style.outline='2px solid var(--red)';g.style.borderRadius='12px';
    setTimeout(()=>g.style.outline='none',800);return;
  }
  const cat = txType==='income' ? 'income' : selCategory;
  try{
    await addDoc(txCol(),{
      amount:Math.round(amt*100)/100, description:dsc, category:cat,
      date:now().toISOString(), createdAt:now().getTime(),
      type: txType
    });
    window.closeMo();
    const sign = txType==='income' ? '+' : '';
    toast(`${sign}${fmt(Math.round(amt*100)/100)} ${txType==='income'?'Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!':'Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!'}`,'ok');
  }catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');console.error(e);}
};

// â”€â”€ Delete TX â”€â”€
window.delTx=(id)=>{
  showCfm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î®Ï‚;',async()=>{
    try{await deleteDoc(txDocRef(id));toast('Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ','ok');}
    catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');}
  });
};

// â”€â”€ Save Settings â”€â”€
window.saveSettings = async ()=>{
  if(!currentUser)return;
  const s={
    income:parseFloat($('sInc').value)||0,
    savings:parseFloat($('sSav').value)||0,
    supermarket:parseFloat($('sSup').value)||0,
    rent:0,loan:0,gym:0,
    lastRecurringMonth: settings.lastRecurringMonth || '',
    walletId: activeWalletId || '',
    quickAdds: settings.quickAdds || DEFAULT_QA,
    fixedBills: settings.fixedBills || DEFAULT_BILLS,
    paidBills: settings.paidBills || {}
  };
  try{
    await setDoc(settingsRef(), s);
    if(activeWalletId){
      await setDoc(userDoc(currentUser.uid,'settings/config'), {walletId: activeWalletId}, {merge:true});
    }
    toast('Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½!','ok');
    const b=$('saveBtn');const o=b.textContent;b.textContent='âœ“ Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!';b.style.background='var(--green)';
    setTimeout(()=>{b.textContent=o;b.style.background='';},1500);
  }catch(e){toast('Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚','err');console.error(e);}
};

// â”€â”€ Clear / Reset â”€â”€
window.clearMonthTx=()=>{
  const n=now(),y=n.getFullYear(),m=n.getMonth();
  const monthTx=transactions.filter(t=>{const d=new Date(t.date);return d.getFullYear()===y&&d.getMonth()===m;});
  if(!monthTx.length){toast('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î±','inf');return;}
  showCfm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® ${monthTx.length} ÏƒÏ…Î½Î±Î»Î»Î±Î³ÏÎ½ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Î¼Î®Î½Î±;`,async()=>{
    try{
      for(const tx of monthTx){await deleteDoc(txDocRef(tx.id));}
      toast(`${monthTx.length} ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½!`,'ok');
    }catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');}
  });
};

window.clearAllTx=()=>{
  if(!transactions.length){toast('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚','inf');return;}
  showCfm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŸÎ›Î©Î Ï„Ï‰Î½ ${transactions.length} ÏƒÏ…Î½Î±Î»Î»Î±Î³ÏÎ½; (Î¿Î¹ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î¸Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½Î¿Ï…Î½)`,async()=>{
    try{
      for(const tx of transactions){await deleteDoc(txDocRef(tx.id));}
      toast('ÎŒÎ»ÎµÏ‚ Î¿Î¹ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½!','ok');
    }catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');}
  });
};

window.resetBillsMonth=()=>{
  const key=currentMonthKey();
  const paid=settings.paidBills||{};
  if(!paid[key]||!paid[key].length){toast('Î¤Î± Ï€Î¬Î³Î¹Î± ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÏƒÎµ ÎµÎºÎºÏÎµÎ¼ÏŒÏ„Î·Ï„Î±','inf');return;}
  showCfm('Reset Ï€Î¬Î³Î¹Î± Î¼Î®Î½Î± ÏƒÎµ "Î•ÎºÎºÏÎµÎ¼ÎµÎ¯"; (Î¿Î¹ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚ Î”Î•Î Î¸Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½)',async()=>{
    try{
      const newPaid={...paid};
      delete newPaid[key];
      await updateDoc(settingsRef(),{paidBills:newPaid});
      toast('Î Î¬Î³Î¹Î± Î¼Î®Î½Î±: Î•ÎºÎºÏÎµÎ¼ÎµÎ¯','ok');
    }catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');}
  });
};

window.confirmReset=()=>{
  showCfm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŸÎ›Î©Î; (ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚ + ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ + Ï€Î¬Î³Î¹Î±)',async()=>{
    try{
      for(const tx of transactions){await deleteDoc(txDocRef(tx.id));}
      await setDoc(settingsRef(),{...DEF,quickAdds:DEFAULT_QA,fixedBills:DEFAULT_BILLS,paidBills:{}});
      toast('Î Î»Î®ÏÎ·Ï‚ ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬!','ok');
    }catch(e){toast('Î£Ï†Î¬Î»Î¼Î±','err');}
  });
};

function fillSettings(){
  $('sInc').value=settings.income;$('sSav').value=settings.savings;
  $('sSup').value=settings.supermarket;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED WALLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code='';for(let i=0;i<6;i++) code+=chars[Math.floor(Math.random()*chars.length)];
  return code;
}

window.createSharedWallet = async ()=>{
  if(!currentUser) return;
  const code = genCode();
  try {
    await setDoc(doc(db,'wallets',code,'meta','info'),{
      createdBy: currentUser.uid, createdAt: Date.now(), members: [currentUser.uid]
    });
    await setDoc(doc(db,'wallets',code,'settings','config'), {...settings, walletId: code});
    await setDoc(userDoc(currentUser.uid,'settings/config'), {walletId:code}, {merge:true});
    activeWalletId = code;
    startListeners(currentUser.uid);
    toast(`ÎšÏ‰Î´Î¹ÎºÏŒÏ‚: ${code}`,'ok');
  } catch(e){ toast('Î£Ï†Î¬Î»Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚','err'); console.error(e); }
};

window.joinSharedWallet = async ()=>{
  if(!currentUser) return;
  const codeEl = document.getElementById('swJoinCode');
  if(!codeEl) return;
  const code = codeEl.value.trim().toUpperCase();
  if(!code || code.length !== 6){ toast('Î’Î¬Î»Îµ 6-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ','err'); return; }
  try {
    const metaSnap = await getDoc(doc(db,'wallets',code,'meta','info'));
    if(!metaSnap.exists()){ toast('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹','err'); return; }
    const meta = metaSnap.data();
    const members = meta.members || [];
    if(!members.includes(currentUser.uid)){
      members.push(currentUser.uid);
      await updateDoc(doc(db,'wallets',code,'meta','info'), { members });
    }
    await setDoc(userDoc(currentUser.uid,'settings/config'), {walletId:code}, {merge:true});
    activeWalletId = code;
    startListeners(currentUser.uid);
    toast('Î£Ï…Î½Î´Î­Î¸Î·ÎºÎµÏ‚ ÏƒÏ„Î¿ ÎºÎ¿Î¹Î½ÏŒ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹!','ok');
  } catch(e){ toast('Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚','err'); console.error(e); }
};

window.leaveSharedWallet = async ()=>{
  if(!currentUser) return;
  showCfm('Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ ÎºÎ¿Î¹Î½ÏŒ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹;', async()=>{
    try {
      await setDoc(userDoc(currentUser.uid,'settings/config'), {walletId:''}, {merge:true});
      activeWalletId = '';
      startListeners(currentUser.uid);
      toast('Î‘Ï€Î¿ÏƒÏ…Î½Î´Î­Î¸Î·ÎºÎµÏ‚','ok');
    } catch(e){ toast('Î£Ï†Î¬Î»Î¼Î±','err'); }
  });
};

function renderSharedWalletUI(){
  const statusEl = $('swStatus');
  const actionsEl = $('swActions');
  if(activeWalletId){
    statusEl.innerHTML = `
      <div class="sw-status"><div class="sw-dot"></div><div class="sw-txt">Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿: ${esc(activeWalletId)}</div></div>
      <div class="sw-code">${esc(activeWalletId)}</div>`;
    actionsEl.innerHTML = `<button class="btn btn-r" onclick="leaveSharedWallet()">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ· ÎšÎ¿Î¹Î½Î¿Ï Î Î¿ÏÏ„Î¿Ï†Î¿Î»Î¹Î¿Ï</button>`;
  } else {
    statusEl.innerHTML = '';
    actionsEl.innerHTML = `
      <button class="btn btn-b" onclick="createSharedWallet()" style="margin-bottom:8px">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎšÏ‰Î´Î¹ÎºÎ¿Ï</button>
      <div class="sw-input-row">
        <input type="text" class="fi" id="swJoinCode" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚" maxlength="6" style="text-transform:uppercase">
        <button class="btn btn-g" onclick="joinSharedWallet()" style="width:auto;padding:14px 20px;flex-shrink:0">Î£ÏÎ½Î´ÎµÏƒÎ·</button>
      </div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.exportCSV = ()=>{
  if(!transactions.length){ toast('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚','err'); return; }
  const header = 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±,Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®,ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±,Î¤ÏÏ€Î¿Ï‚,Î Î¿ÏƒÏŒ\n';
  const rows = transactions.map(tx => {
    const d = new Date(tx.date);
    const dateStr = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
    const cat = CATS[tx.category] ? CATS[tx.category].label : tx.category;
    const desc = `"${tx.description.replace(/"/g, '""')}"`;
    const typeLabel = tx.type==='income' ? 'ÎˆÏƒÎ¿Î´Î¿' : 'ÎˆÎ¾Î¿Î´Î¿';
    const sign = tx.type==='income' ? '+' : '-';
    return `${dateStr},${desc},${cat},${typeLabel},${sign}${tx.amount.toFixed(2)}`;
  }).join('\n');
  const csv = '\uFEFF' + header + rows;
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const n = now();
  a.href = url;
  a.download = `smartwallet_${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}.csv`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('CSV ÎµÎ¾Î®Ï‡Î¸Î·!','ok');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI TIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tips(){
  const t=[];const b=safe();const sp=tSpent();
  const tr=cSum('transport'),su=cSum('super'),fd=cSum('food'),en=cSum('ent'),sh=cSum('shop');

  if(b<50&&sp>0)t.push({icon:'ğŸš¨',tag:'ÎšÏÎ¯ÏƒÎ¹Î¼Î· Î•Î¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·',txt:'ÎšÏÎ¯ÏƒÎ¹Î¼Î¿! Î Î¬Î³Ï‰ÏƒÎµ ÎºÎ¬Î¸Îµ Î¼Î· Î±Î½Î±Î³ÎºÎ±Î¯Î¿ Î­Î¾Î¿Î´Î¿ Î±Î¼Î­ÏƒÏ‰Ï‚!',color:'var(--red)'});
  else if(b<100&&sp>0)t.push({icon:'âš ï¸',tag:'Î ÏÎ¿ÏƒÎ¿Ï‡Î®',txt:'Î§Î±Î¼Î·Î»ÏŒ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿! Î•ÏƒÏ„Î¯Î±ÏƒÎµ Î¼ÏŒÎ½Î¿ ÏƒÏ„Î± Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î±.',color:'var(--orange)'});
  if(tr>80)t.push({icon:'ğŸš—',tag:'ÎœÎµÏ„Î±Ï†Î¿ÏÎ¹ÎºÎ¬',txt:`Î¥ÏˆÎ·Î»Î¬ Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¹ÎºÎ¬ (${fmt(tr)}). Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ ÎœÎœÎœ, Î³Î»Î¯Ï„Ï‰ÏƒÎµ ~70â‚¬/Î¼Î®Î½Î±.`,color:'var(--blue)'});
  if(su>settings.supermarket&&settings.supermarket>0)t.push({icon:'ğŸ›’',tag:'Î£Î¿ÏÏ€ÎµÏ ÎœÎ¬ÏÎºÎµÏ„',txt:`ÎÎµÏ€Î­ÏÎ±ÏƒÎµÏ‚ Ï„Î¿Î½ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ (${fmt(su)}/${fmt(settings.supermarket)}). Î¨Î¬Î¾Îµ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ­Ï‚!`,color:'var(--yellow)'});
  if(fd>100)t.push({icon:'ğŸ•',tag:'Î¦Î±Î³Î·Ï„ÏŒ',txt:`Î Î¿Î»Î»Î¬ ÏƒÎµ Ï†Î±Î³Î·Ï„ÏŒ Î­Î¾Ï‰ (${fmt(fd)}). ÎœÎ±Î³ÎµÎ¯ÏÎµÏˆÎµ ÏƒÏ€Î¯Ï„Î¹!`,color:'var(--orange)'});
  if(en>60)t.push({icon:'ğŸ¬',tag:'Î¨Ï…Ï‡Î±Î³Ï‰Î³Î¯Î±',txt:`ÎˆÎ¾Î¿Î´Î± ÏˆÏ…Ï‡Î±Î³Ï‰Î³Î¯Î±Ï‚ ${fmt(en)}. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î´Ï‰ÏÎµÎ¬Î½ Î´ÏÎ±ÏƒÏ„Î·ÏÎ¹ÏŒÏ„Î·Ï„ÎµÏ‚!`,color:'var(--purple)'});
  if(sh>80)t.push({icon:'ğŸ›ï¸',tag:'Î‘Î³Î¿ÏÎ­Ï‚',txt:`Î Î¿Î»Î»Î¬ ÏƒÎµ Î±Î³Î¿ÏÎ­Ï‚ (${fmt(sh)}). Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬ Î±Ï…Ï„Î¬;`,color:'var(--pink)'});
  if(b>=settings.savings&&sp>0&&settings.savings>0)t.push({icon:'âœ…',tag:'Î‘Ï€Î¿Ï„Î±Î¼Î¯ÎµÏ…ÏƒÎ·',txt:`ÎœÏ€ÏÎ¬Î²Î¿! On track Î³Î¹Î± ${fmt(settings.savings)} Î±Ï€Î¿Ï„Î±Î¼Î¯ÎµÏ…ÏƒÎ·!`,color:'var(--green)'});
  if(sp===0&&tExtraIncome()===0)t.push({icon:'ğŸ’¡',tag:'ÎÎµÎºÎ¯Î½Î±',txt:'Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï„Î± Ï€ÏÏÏ„Î± ÏƒÎ¿Ï… Î­Î¾Î¿Î´Î± Î³Î¹Î± ÏƒÏ…Î¼Î²Î¿Ï…Î»Î­Ï‚!',color:'var(--blue)'});

  const extra = tExtraIncome();
  if(extra>0)t.push({icon:'ğŸ’°',tag:'ÎˆÎºÏ„Î±ÎºÏ„Î± ÎˆÏƒÎ¿Î´Î±',txt:`+${fmt(extra)} Î­ÎºÏ„Î±ÎºÏ„Î± Î­ÏƒÎ¿Î´Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î±!`,color:'var(--green)'});

  const d=now().getDate(),dm=dim(),spendable=totalIncome()-fixed()-settings.savings;
  if(d<=dm/2&&sp>spendable*.6&&sp>0&&spendable>0)t.push({icon:'ğŸ“ˆ',tag:'Î¡Ï…Î¸Î¼ÏŒÏ‚',txt:'Î Î¬Î½Ï‰ Î±Ï€ÏŒ 60% ÏƒÏ„Î¿ Î¼Î¹ÏƒÏŒ Î¼Î®Î½Î±. Î ÏÏŒÏƒÎµÎ¾Îµ!',color:'var(--orange)'});
  return t;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){renderDash();renderTxL('recTx',5);renderTxPage();renderQuickAdds();renderBills();}

function renderDash(){
  const b=safe();$('balNum').textContent=fmt(b);$('balNum').className='bal-n '+(b>=0?'pos':'neg');
  const ti=totalIncome();
  $('balLbl').textContent=`Î±Ï€ÏŒ ${fmt(ti)} ÎµÎ¹ÏƒÏŒÎ´Î·Î¼Î±` + (tExtraIncome()>0 ? ` (+${fmt(tExtraIncome())} Î­ÎºÏ„Î±ÎºÏ„Î±)` : '');
  $('wkVal').textContent=fmt(b>0?b/wleft():0);
  $('dyVal').textContent=fmt(b>0?b/dleftN():0);
  $('dLeft').textContent=dleft();
  renderProg();renderTips();
}

function renderProg(){
  const sp=totalIncome()-fixed()-settings.savings, ts=tSpent();
  const cats=[{k:'super',l:'Î£Î¿ÏÏ€ÎµÏ ÎœÎ¬ÏÎºÎµÏ„',b:settings.supermarket,i:'ğŸ›’'},{k:'food',l:'Î¦Î±Î³Î·Ï„ÏŒ',b:100,i:'ğŸ•'},
  {k:'transport',l:'ÎœÎµÏ„Î±Ï†Î¿ÏÎ¹ÎºÎ¬',b:80,i:'ğŸš—'},{k:'ent',l:'Î¨Ï…Ï‡Î±Î³Ï‰Î³Î¯Î±',b:60,i:'ğŸ¬'},{k:'shop',l:'Î‘Î³Î¿ÏÎ­Ï‚',b:80,i:'ğŸ›ï¸'}];
  let h='';
  if(sp>0){
    const op=Math.min(100,(ts/sp)*100);
    const oc=op>90?'var(--red)':op>70?'var(--orange)':'var(--green)';
    h+=`<div class="pr-w"><div class="pr-h"><span class="pr-n">ğŸ’° Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬</span><span class="pr-v">${fmt(ts)} / ${fmt(sp)}</span></div><div class="pr-bar"><div class="pr-fill" style="width:${op}%;background:${oc}"></div></div></div>`;
  }
  cats.forEach(c=>{const s=cSum(c.k);if(!s)return;const p=Math.min(100,(s/c.b)*100);
  const cl=p>100?'var(--red)':p>75?'var(--orange)':'var(--green)';
  h+=`<div class="pr-w"><div class="pr-h"><span class="pr-n">${c.i} ${c.l}</span><span class="pr-v">${fmt(s)} / ${fmt(c.b)}</span></div><div class="pr-bar"><div class="pr-fill" style="width:${p}%;background:${cl}"></div></div></div>`;});
  $('progBars').innerHTML=h;
}

function renderTips(){
  const t=tips();if(!t.length){$('tipBox').innerHTML='';return;}
  $('tipBox').innerHTML=t.map(x=>`<div class="tip"><div class="tip-tag" style="color:${x.color}">ğŸ¤– ${x.tag}</div><div class="tip-ico">${x.icon}</div><div class="tip-txt">${x.txt}</div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSACTION LIST (income-aware)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTxPage(){
  const searchVal = $('txSearch') ? $('txSearch').value.trim().toLowerCase() : '';
  let items = transactions;
  if(searchVal){
    items = transactions.filter(tx => tx.description.toLowerCase().includes(searchVal));
  }
  renderTxL('allTx', 0, items);
}

function renderTxL(id, lim, customItems){
  const el=$(id);
  const items = customItems ? (lim>0 ? customItems.slice(0,lim) : customItems) : (lim>0?transactions.slice(0,lim):transactions);
  if(!items.length){el.innerHTML=`<div class="empty"><div class="empty-i">ğŸ“</div><div class="empty-t">${id==='allTx'&&$('txSearch')&&$('txSearch').value?'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±.':'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚ Î±ÎºÏŒÎ¼Î±.<br>Î Î¬Ï„Î± Ï„Î¿ + Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚!'}</div></div>`;return;}
  let h='',last='';
  items.forEach(tx=>{const dl=fDate(tx.date);if(dl!==last){last=dl;h+=`<div class="dsep">${dl}</div>`;}
  const isIncome = tx.type==='income';
  const c = CATS[tx.category]||CATS.other;
  const recurIcon = tx.recurring ? ' ğŸ”' : '';
  const amtClass = isIncome ? 'tx-a income' : 'tx-a expense';
  const amtPrefix = isIncome ? '+' : '-';
  h+=`<div class="tx-wrap" data-txid="${tx.id}">
    <div class="tx-del-bg">Î”Î¹Î±Î³ÏÎ±Ï†Î®</div>
    <div class="tx">
      <div class="tx-ic ${c.css}">${c.icon}</div>
      <div class="tx-d"><div class="tx-n">${esc(tx.description)}${recurIcon}</div><div class="tx-m">${c.label} Â· ${fTime(tx.date)}</div></div>
      <div class="${amtClass}">${amtPrefix}${fmt(tx.amount)}</div>
    </div>
  </div>`;});
  el.innerHTML=h;
  el.querySelectorAll('.tx-wrap').forEach(initSwipe);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWIPE TO DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSwipe(wrap){
  let startX=0, currentX=0, isSwiping=false, swiped=false;
  const txEl = wrap.querySelector('.tx');
  const threshold = 80;

  wrap.addEventListener('touchstart', e=>{
    if(swiped){ wrap.classList.remove('swiped');txEl.style.transform='';swiped=false;return; }
    startX = e.touches[0].clientX; isSwiping = false;
  }, {passive:true});

  wrap.addEventListener('touchmove', e=>{
    const diffX = e.touches[0].clientX - startX;
    if(diffX < -10) isSwiping = true;
    if(!isSwiping) return;
    currentX = Math.min(0, Math.max(-120, diffX));
    txEl.style.transform = `translateX(${currentX}px)`;
    txEl.style.transition = 'none';
  }, {passive:true});

  wrap.addEventListener('touchend', ()=>{
    txEl.style.transition = 'transform .25s ease';
    if(currentX < -threshold){ txEl.style.transform=`translateX(-80px)`;wrap.classList.add('swiped');swiped=true; }
    else { txEl.style.transform='';wrap.classList.remove('swiped');swiped=false; }
    currentX=0;isSwiping=false;
  }, {passive:true});

  wrap.querySelector('.tx-del-bg').addEventListener('click', ()=>{ window.delTx(wrap.dataset.txid); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATISTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats(){ renderBarChart(); renderCatBreakdown(); renderComparison(); renderCatComparison(); renderAiInsights(); }

function renderBarChart(){
  const n = now(); const months = [];
  for(let i=5;i>=0;i--){
    let m=n.getMonth()-i, y=n.getFullYear();
    if(m<0){m+=12;y--;}
    months.push({label:MONTH_NAMES[m], spent:spentForMonth(y,m)});
  }
  const maxS = Math.max(...months.map(m=>m.spent), 1);
  $('barChart').innerHTML = months.map(m=>{
    const pct = (m.spent/maxS)*100;
    return `<div class="bar-col"><div class="bar-val">${m.spent>0?Math.round(m.spent)+'â‚¬':'-'}</div>
    <div class="bar-rect" style="height:${Math.max(pct,3)}%"></div><div class="bar-lbl">${m.label}</div></div>`;
  }).join('');
}

function renderCatBreakdown(){
  const monthExp = mExpenses();
  const total = monthExp.reduce((s,t)=>s+t.amount,0) || 1;
  const catTotals = {};
  monthExp.forEach(tx=>{ catTotals[tx.category] = (catTotals[tx.category]||0) + tx.amount; });
  const sorted = Object.entries(catTotals).sort((a,b)=>b[1]-a[1]);
  const colors = {food:'var(--orange)',super:'var(--yellow)',transport:'var(--blue)',
    ent:'var(--purple)',shop:'var(--pink)',health:'var(--green)',bills:'var(--red)',other:'var(--text2)'};
  if(!sorted.length){
    $('catBreakdown').innerHTML = '<div class="empty"><div class="empty-t">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­Î¾Î¿Î´Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î±.</div></div>';return;
  }
  $('catBreakdown').innerHTML = sorted.map(([cat, amt])=>{
    const c=CATS[cat]||CATS.other; const pct=(amt/total*100).toFixed(1); const color=colors[cat]||'var(--text2)';
    return `<div class="cat-bar-row"><div class="cat-bar-icon">${c.icon}</div><div class="cat-bar-info">
    <div class="cat-bar-top"><span class="cat-bar-name">${c.label}</span><span class="cat-bar-val">${fmt(amt)} (${pct}%)</span></div>
    <div class="cat-bar-track"><div class="cat-bar-fill" style="width:${pct}%;background:${color}"></div></div></div></div>`;
  }).join('');
}

function renderComparison(){
  const n=now();
  const curSpent=spentForMonth(n.getFullYear(),n.getMonth());
  let prevM=n.getMonth()-1, prevY=n.getFullYear();
  if(prevM<0){prevM=11;prevY--;}
  const prevSpent=spentForMonth(prevY,prevM);
  const diff=curSpent-prevSpent;
  const diffPct=prevSpent>0?((diff/prevSpent)*100).toFixed(0):0;
  const diffColor=diff>0?'var(--red)':'var(--green)';
  const diffSign=diff>0?'+':'';
  const diffText=prevSpent>0?`${diffSign}${diffPct}% vs Ï€ÏÎ¿Î·Î³.`:'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±';
  $('cmpRow').innerHTML = `
    <div class="cmp-card"><div class="cmp-lbl">${MONTH_NAMES[n.getMonth()]} (Î¤ÏÎ­Ï‡Ï‰Î½)</div>
    <div class="cmp-val" style="color:var(--blue)">${fmt(curSpent)}</div></div>
    <div class="cmp-card"><div class="cmp-lbl">${MONTH_NAMES[prevM]} (Î ÏÎ¿Î·Î³.)</div>
    <div class="cmp-val" style="color:var(--text2)">${fmt(prevSpent)}</div>
    <div class="cmp-diff" style="color:${diffColor}">${diffText}</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAILED CATEGORY COMPARISON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCatComparison(){
  const n=now();
  const curY=n.getFullYear(), curM=n.getMonth();
  let prevM=curM-1, prevY=curY;
  if(prevM<0){prevM=11;prevY--;}

  const allCats=['food','super','transport','ent','shop','health','bills','other'];
  const rows=[];

  allCats.forEach(cat=>{
    const cur=catSumForMonth(cat,curY,curM);
    const prev=catSumForMonth(cat,prevY,prevM);
    if(cur===0&&prev===0) return;
    const diff=cur-prev;
    rows.push({cat,cur,prev,diff});
  });

  if(!rows.length){
    $('catCompare').innerHTML='<div class="empty"><div class="empty-t">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÎºÎµÏ„Î¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·.</div></div>';
    return;
  }

  // Sort by absolute diff descending
  rows.sort((a,b)=>Math.abs(b.diff)-Math.abs(a.diff));

  $('catCompare').innerHTML = rows.map(r=>{
    const c=CATS[r.cat]||CATS.other;
    let diffClass, diffText;
    if(r.diff<-0.5){
      diffClass='better';
      diffText=`-${fmt(Math.abs(r.diff))}`;
    } else if(r.diff>0.5){
      diffClass='worse';
      diffText=`+${fmt(r.diff)}`;
    } else {
      diffClass='same';
      diffText='ÎŠÎ´Î¹Î±';
    }
    return `<div class="cat-cmp-row">
      <div class="cat-cmp-icon">${c.icon}</div>
      <div class="cat-cmp-info">
        <div class="cat-cmp-name">${c.label}</div>
        <div class="cat-cmp-vals">${MONTH_NAMES[curM]}: ${fmt(r.cur)} Â· ${MONTH_NAMES[prevM]}: ${fmt(r.prev)}</div>
      </div>
      <div class="cat-cmp-diff ${diffClass}">${diffText}</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI MONTHLY INSIGHTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAiInsights(){
  const n=now();
  const curY=n.getFullYear(), curM=n.getMonth();
  let prevM=curM-1, prevY=curY;
  if(prevM<0){prevM=11;prevY--;}

  const curTotal=spentForMonth(curY,curM);
  const prevTotal=spentForMonth(prevY,prevM);
  const insights=[];

  if(prevTotal===0&&curTotal===0){
    $('aiInsights').innerHTML='<div class="empty"><div class="empty-t">Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î­Î¾Î¿Î´Î± Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ AI Î±Î½Î¬Î»Ï…ÏƒÎ·!</div></div>';
    return;
  }

  // Overall comparison
  if(prevTotal>0){
    const totalDiff=curTotal-prevTotal;
    const pct=((totalDiff/prevTotal)*100).toFixed(0);
    if(totalDiff<-5){
      insights.push({icon:'ğŸ‰',txt:`ÎœÏ€ÏÎ¬Î²Î¿! ÎÎ¿Î´ÎµÏÎµÎ¹Ï‚ ${fmt(Math.abs(totalDiff))} Î»Î¹Î³ÏŒÏ„ÎµÏÎ± (${Math.abs(pct)}% ÎºÎ¬Ï„Ï‰) Î±Ï€ÏŒ Ï„Î¿Î½ ${MONTH_NAMES[prevM]}. Î£Ï…Î½Î­Ï‡Î¹ÏƒÎµ Î­Ï„ÏƒÎ¹!`});
    } else if(totalDiff>50){
      insights.push({icon:'âš ï¸',txt:`Î ÏÏŒÏƒÎµÎ¾Îµ! Î¤Î± Î­Î¾Î¿Î´Î¬ ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ ${fmt(totalDiff)} Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± (+${pct}%) Î±Ï€ÏŒ Ï„Î¿Î½ ${MONTH_NAMES[prevM]}. Î”ÎµÏ‚ Ï€Î¿Ï Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÎºÏŒÏˆÎµÎ¹Ï‚.`});
    } else if(totalDiff>5){
      insights.push({icon:'ğŸ“Š',txt:`ÎœÎ¹ÎºÏÎ® Î±ÏÎ¾Î·ÏƒÎ· ${fmt(totalDiff)} (+${pct}%) vs ${MONTH_NAMES[prevM]}. Î¤Î¯Ï€Î¿Ï„Î± Î±Î½Î·ÏƒÏ…Ï‡Î·Ï„Î¹ÎºÏŒ, Î±Î»Î»Î¬ Ï€ÏÏŒÏƒÎµÏ‡Îµ.`});
    }
  }

  // Per-category insights
  const allCats=['food','super','transport','ent','shop','health','bills'];
  allCats.forEach(cat=>{
    const cur=catSumForMonth(cat,curY,curM);
    const prev=catSumForMonth(cat,prevY,prevM);
    if(cur===0&&prev===0) return;
    const c=CATS[cat]||CATS.other;
    const diff=cur-prev;

    if(prev>0&&diff<-10){
      const pct=((Math.abs(diff)/prev)*100).toFixed(0);
      insights.push({icon:'âœ…',txt:`${c.icon} ${c.label}: ÎÎ¿Î´ÎµÏÎµÎ¹Ï‚ ${fmt(Math.abs(diff))} Î»Î¹Î³ÏŒÏ„ÎµÏÎ± (-${pct}%)! ÎœÏ€ÏÎ¬Î²Î¿ ÏƒÎ¿Ï…!`});
    } else if(prev>0&&diff>20){
      const pct=((diff/prev)*100).toFixed(0);
      insights.push({icon:'ğŸ”º',txt:`${c.icon} ${c.label}: +${fmt(diff)} Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ (+${pct}%) Î±Ï€ÏŒ Ï„Î¿Î½ ${MONTH_NAMES[prevM]}. ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï„Î¿ Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚;`});
    } else if(cur>0&&prev===0){
      insights.push({icon:'ğŸ†•',txt:`${c.icon} ${c.label}: ÎÎ­Î± ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î± (${fmt(cur)}). Î ÏÏŒÏƒÎµÎ¾Îµ Î½Î± Î¼Î·Î½ Î¾ÎµÏ†ÏÎ³ÎµÎ¹.`});
    }
  });

  // Top spending category
  const catTotals={};
  mExpenses().forEach(tx=>{catTotals[tx.category]=(catTotals[tx.category]||0)+tx.amount;});
  const topCat=Object.entries(catTotals).sort((a,b)=>b[1]-a[1])[0];
  if(topCat){
    const tc=CATS[topCat[0]]||CATS.other;
    const topPct=((topCat[1]/curTotal)*100).toFixed(0);
    insights.push({icon:'ğŸ“',txt:`Î— ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ${tc.icon} ${tc.label} ÎµÎ¯Î½Î±Î¹ Î· #1 ÏƒÎ¿Ï… (${topPct}% Ï„Ï‰Î½ ÎµÎ¾ÏŒÎ´Ï‰Î½). ${topCat[1]>100?'Î£ÎºÎ­ÏˆÎ¿Ï… Ï„ÏÏŒÏ€Î¿Ï…Ï‚ Î½Î± Ï„Î· Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚.':'Î›Î¿Î³Î¹ÎºÏŒ ÎµÏ€Î¯Ï€ÎµÎ´Î¿.'}`});
  }

  // Days analysis
  const daysPassed=n.getDate();
  const daysInMonth=dim();
  const dailyAvg=curTotal/daysPassed;
  const projected=dailyAvg*daysInMonth;
  if(daysPassed>=5&&curTotal>0){
    insights.push({icon:'ğŸ“ˆ',txt:`ÎœÎµ ÏÏ…Î¸Î¼ÏŒ ${fmt(dailyAvg)}/Î·Î¼Î­ÏÎ±, Î¸Î± Ï†Ï„Î¬ÏƒÎµÎ¹Ï‚ ~${fmt(projected)} Ï‰Ï‚ Ï„Î­Î»Î¿Ï‚ Î¼Î®Î½Î±. ${projected>totalIncome()-fixed()?'Î‘Ï…Ï„ÏŒ Î¾ÎµÏ€ÎµÏÎ½Î¬ Ï„Î± ÏŒÏÎ¹Î¬ ÏƒÎ¿Ï…!':'ÎœÎ­ÏƒÎ± ÏƒÏ„Î± Ï€Î»Î¬Î½Î± ÏƒÎ¿Ï….'}`});
  }

  if(!insights.length){
    insights.push({icon:'ğŸ’¡',txt:'Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Ï€Î¹Î¿ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬ insights!'});
  }

  $('aiInsights').innerHTML = insights.map(i=>
    `<div class="ai-insight"><div class="ai-insight-ico">${i.icon}</div><div class="ai-insight-txt">${i.txt}</div></div>`
  ).join('');
}
</script>
</body>
</html>
